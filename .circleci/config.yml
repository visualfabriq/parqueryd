version: 2.1
orbs:
  codeartifact: visualfabriq/codeartifact@1.3.21
  coverage-reporter: codacy/coverage-reporter@14.1.0

jobs:
  test:
    executor: codeartifact/default
    parameters:
      with-coverage:
        description: Coverage reporting flag
        type: boolean
        default: false
      runtime:
        description: Python runtime version
        type: string
        default: "3.11"
      resource-class:
        description: Resource class (medium for x86, arm.medium for ARM64)
        type: string
        default: "medium"
    resource_class: <<parameters.resource-class>>
    docker:
      - image: cimg/python:<<parameters.runtime>> # Ubuntu 22.04 with glibc 2.35
      - image: redis:latest

    working_directory: ~/parqueryd
    steps:
      - checkout

      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      - restore_cache:
          keys:
            - << parameters.resource-class >>-<< parameters.runtime >>-v2-uv-{{ checksum "setup.py" }}
            - << parameters.resource-class >>-<< parameters.runtime >>-v2-uv

      - run:
          name: Create virtualenv with uv
          command: uv venv --clear ~/venv

      - codeartifact/init:
          tool: pip

      - run:
          name: Install dependencies with uv
          command: |
            source ~/venv/bin/activate
            uv pip install .[test]

      # Save the cached dependencies
      - save_cache:
          key: << parameters.resource-class >>-<< parameters.runtime >>-v2-uv-{{ checksum "setup.py" }}
          paths:
            - ~/venv
            - ~/.cache/uv
            - ~/.cargo/bin/uv

      # Save git revision info
      - run:
          name: save GIT revision info
          command: |
            git rev-parse HEAD > git_hash.txt

      - run:
          name: set variables
          command: |
            # Enable debug mode
            export LOG_LEVEL=debug

      - when:
          condition:
            not: << parameters.with-coverage >>
          steps:
            - run:
                name: Run tests
                command: ~/venv/bin/python -m pytest tests
      - when:
          condition: << parameters.with-coverage >>
          steps:
            - run:
                name: Run tests with coverage reporting
                command: |
                  ~/venv/bin/python -m coverage run -m \
                    pytest tests --junitxml=test-results/pytest/pytest-report.xml
                  ~/venv/bin/python -m coverage xml -o cobertura.xml
            - store_test_results:
                path: test-results
            - store_artifacts:
                path: test-results
            - coverage-reporter/send_report

  build-and-push:
    executor: codeartifact/default
    parameters:
      is-pre-release:
        description: if true the version tag will contain the branch
        type: boolean
        default: false
    steps:
      - checkout

      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      - codeartifact/init:
          tool: pip
      - when:
          condition: << parameters.is-pre-release >>
          steps:
            - codeartifact/pre_release_version:
                package: parqueryd
      - run:
          name: Build
          command: |
            uv pip install --system build
            python -m build
      - codeartifact/push:
          tool: twine

workflows:
  version: 2.1
  build-and-test:
    jobs:
      - test:
          context: codeartifact-dev
          name: py311-x86
          runtime: "3.11"
          resource-class: "medium"
          with-coverage: true

      - test:
          context: codeartifact-dev
          name: py311-arm64
          runtime: "3.11"
          resource-class: "arm.medium"
          with-coverage: false

      - build-and-push:
          context: codeartifact-dev
          requires:
            - py311-x86
            - py311-arm64
          filters:
            branches:
              only:
                - master
                - main

      - build-and-push:
          context: codeartifact-dev
          requires:
            - py311-x86
            - py311-arm64
          is-pre-release: true
          filters:
            branches:
              only:
                - uat
